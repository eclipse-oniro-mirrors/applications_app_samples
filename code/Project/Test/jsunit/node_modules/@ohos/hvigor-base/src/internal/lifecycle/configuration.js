"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.configuration=void 0;const path_1=__importDefault(require("path")),global_data_js_1=require("../data/global-data.js"),process_1=__importDefault(require("process")),fs_1=__importDefault(require("fs")),hvigor_log_js_1=require("../../log/hvigor-log.js"),index_js_1=require("../../../index.js"),time_util_js_1=require("../../util/time-util.js"),task_tree_js_1=require("../task/build/task-tree.js"),ts_check_js_1=require("../util/ts_check.js"),_log=hvigor_log_js_1.HvigorLogger.getLogger("hvigor-configuration");function configuration(){const e=process_1.default.hrtime(),i=global_data_js_1.globalData.cliEnv,o=index_js_1.hvigor.getProject(),t=path_1.default.resolve(i.cwd,index_js_1.HvigorCommonConst.BUILD_FILE_NAME);for(const e of o.getAllSubModules())configNodeTask(e),evaluateNodeVigorFile(e,findRealHvigorFilePath(e.getBuildFilePath()));configNodeTask(o),evaluateNodeVigorFile(o,findRealHvigorFilePath(t));const r=process_1.default.hrtime(e),s=(0,time_util_js_1.formatTime)(r);return _log.debug(`Configuration phase cost:${s}`),o}function configNodeTask(e){e.registry(new index_js_1.Tasks(e)),e.registry(new task_tree_js_1.TaskTree(e))}function findRealHvigorFilePath(e){for(const i of index_js_1.HvigorCommonConst.BUILD_FILE_NAME_SUFFIX){const o=`${e}${i}`;if(fs_1.default.existsSync(o))return o}_log.errorMessageExit(`Hvigorfile not found: ${e}.ts/js`)}function evaluateNodeVigorFile(e,i){index_js_1.hvigor.startParameters.hvigorfileTypeCheck&&i.endsWith(".ts")&&ts_check_js_1.hvigorfileTSRoots.add(i);const o=require(i);if("function"==typeof o){const i=o(e);e.bindPlugin(i)}else o instanceof index_js_1.HvigorPlugin||(Object.keys(o).length||_log.errorMessageExit(`No exports were found in hvigorfile: ${i}`),Object.keys(o).forEach((i=>{const t=o[i];if(t instanceof index_js_1.HvigorPlugin)e.bindPlugin(t);else if("function"==typeof t){const i=t(e);e.bindPlugin(i)}})))}exports.configuration=configuration;