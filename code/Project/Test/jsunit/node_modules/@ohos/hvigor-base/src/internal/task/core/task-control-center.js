"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,a){void 0===a&&(a=s);var r=Object.getOwnPropertyDescriptor(t,s);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,a,r)}:function(e,t,s,a){void 0===a&&(a=s),e[a]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.taskControlCenter=exports.TaskControlCenter=void 0;const task_queue_js_1=require("./task-queue.js"),events_1=__importDefault(require("events")),task_directed_acyclic_graph_js_1=require("./task-directed-acyclic-graph.js"),task_util_js_1=require("../util/task-util.js"),ts_check_js_1=require("../../util/ts_check.js"),parse_json_util_js_1=require("../../../util/parse/parse-json-util.js"),path=__importStar(require("path")),common_const_1=require("../../../options/common-const");class TaskControlCenter extends events_1.default{constructor(){super(),this.blockedTaskMap=new Map,this.runnableTaskQueue=new task_queue_js_1.TaskQueue,this.runningTaskList=new Map}initTaskQueueBeforeRun(e){e.forEach((e=>{this.initTaskQueueForOneTask((0,task_util_js_1.findTaskByPath)(e))}))}initTaskQueueForOneTask(e){this.updateTargetRoots(e);const t=[...task_directed_acyclic_graph_js_1.projectTaskDag.getChildren(e.getPath()).values()];this.blockedTaskMap.set(e.getPath(),t.length),0===t.length?this.runnableTaskQueue.push(e):t.forEach((e=>{this.blockedTaskMap.has(e)||this.initTaskQueueForOneTask((0,task_util_js_1.findTaskByPath)(e))}))}updateTargetRoots(e){const t=e.getNode().getName();if(ts_check_js_1.targetModules.has(t))return;const s=`${e.getNode().getBuildFilePath()}.ts`;if(!e.getEnabled()||!ts_check_js_1.hvigorfileTSRoots.has(s))return;ts_check_js_1.targetRoots.add(s),ts_check_js_1.targetModules.add(t);const a=(0,parse_json_util_js_1.parseJsonFile)(e.getNode().getBuildProfilePath()).entryModules;if(a)for(const t of a){const s=path.resolve(e.getNode().getNodeDir(),"..",t,`${common_const_1.HvigorCommonConst.BUILD_FILE_NAME}.ts`);ts_check_js_1.hvigorfileTSRoots.has(s)&&(ts_check_js_1.targetRoots.add(s),ts_check_js_1.targetModules.add(t))}}clearRunnableTaskQueue(){this.runnableTaskQueue.clear()}allTasksHasExecuted(){return 0===this.blockedTaskMap.size}popRunnableTask(){return this.runnableTaskQueue.pop()}getRunnableTaskSize(){return this.runnableTaskQueue.size()}setTaskExecuted(e){this.blockedTaskMap.delete(e);task_directed_acyclic_graph_js_1.projectTaskDag.getParent(e).forEach((e=>{if(!this.blockedTaskMap.has(e))return;const t=this.blockedTaskMap.get(e)-1;this.blockedTaskMap.set(e,t),0===t&&this.runnableTaskQueue.push((0,task_util_js_1.findTaskByPath)(e))}))}pushRunningTask(e){this.runningTaskList.set(e.getPath(),e)}getRunningTask(e){return this.runningTaskList.get(e)}setIntervalId(e){this.intervalId=e}clearInterval(){clearInterval(this.intervalId)}}exports.TaskControlCenter=TaskControlCenter,exports.taskControlCenter=new TaskControlCenter;