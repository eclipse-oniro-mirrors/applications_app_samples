"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyGenLiteSource=void 0;const ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),ohos_hap_task_js_1=require("../task/ohos-hap-task.js"),legacy_compile_lite_node_js_1=require("./legacy-compile-lite-node.js"),fs_extra_1=__importDefault(require("fs-extra")),path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../../builder/inner-java-command-builder/packing-tool-options.js"),process_utils_js_1=require("../../utils/process-utils.js"),file_util_js_1=require("../../utils/file-util.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),task_names_js_1=require("../common/task-names.js"),lodash_1=require("lodash");class LegacyGenLiteSource extends ohos_hap_task_js_1.OhosHapTask{constructor(e){super(e,task_names_js_1.TaskNames.LegacyFATask.GENERATE_LITE_CODE),this._logger=ohos_logger_js_1.OhosLogger.getLogger(LegacyGenLiteSource.name)}taskShouldDo(){return this.service.needPackBin()}initTaskDepends(){this.module.registryDependsOnTask(this,new legacy_compile_lite_node_js_1.LegacyCompileLiteNode(this.targetService))}doTaskAction(){const e=this.pathInfo,t=path_1.default.resolve(e.getIntermediatesLiteSource(),"assets");fs_extra_1.default.copySync(e.getIntermediatesFaAssetsPath(),t);const s=path_1.default.resolve(e.getIntermediatesRes(),"config.json"),o=path_1.default.resolve(e.getIntermediatesLiteSource(),"config.json");fs_extra_1.default.copyFileSync(s,o);const i=path_1.default.resolve(e.getIntermediatesRes(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES),r=path_1.default.resolve(t,this.module.getName(),build_directory_const_js_1.BuildDirConst.RESTOOL_BUILD_RESOURCES);fs_extra_1.default.copySync(i,r),fs_extra_1.default.copySync(e.getIntermediatesLiteBinSource(),r);const a=path_1.default.resolve(e.getIntermediatesRes(),"resources.index"),_=path_1.default.resolve(t,this.module.getName(),"resources.index");fs_extra_1.default.copyFileSync(a,_);const l=new packing_tool_options_js_1.PackingToolOptions;l.addCalledJarFile(this.sdkInfo.getHapTobin()),l.addProjectPath(e.getIntermediatesLiteSource()).addBinPath(path_1.default.resolve(e.getModuleBinOutput(),this.targetData.getModuleTargetOutputFileName("",null,build_directory_const_js_1.BuildArtifactExtension.DOT_BIN))),this._logger.debug(l.build()),file_util_js_1.FileUtil.checkDirWithoutDelete(e.getModuleBinOutput());const u={moduleName:this.moduleName,commandLine:l.build()};new process_utils_js_1.ProcessUtils(u.moduleName).submitSyncExecutionWithoutReturn(this.getWorkerPool(),u,lodash_1.noop,[])}beforeTask(){fs_extra_1.default.emptyDirSync(this.pathInfo.getIntermediatesLiteSource())}}exports.LegacyGenLiteSource=LegacyGenLiteSource;