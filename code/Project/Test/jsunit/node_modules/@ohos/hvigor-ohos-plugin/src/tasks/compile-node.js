"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,o){void 0===o&&(o=s);var i=Object.getOwnPropertyDescriptor(t,s);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,o,i)}:function(e,t,s,o){void 0===o&&(o=s),e[o]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.CompileNode=void 0;const code_type_enum_js_1=require("../enum/code-type-enum.js"),path_1=__importDefault(require("path")),fse=__importStar(require("fs-extra")),ohos_hap_task_js_1=require("./task/ohos-hap-task.js"),node_command_builder_js_1=require("../builder/node-command-builder.js"),common_const_js_1=require("../const/common-const.js"),build_directory_const_js_1=require("../const/build-directory-const.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),generate_loader_json_js_1=require("./generate-loader-json.js"),compile_resource_js_1=require("./compile-resource.js"),inject_util_js_1=require("../utils/inject-util.js"),project_file_reader_js_1=require("../utils/project-file-reader.js"),process_utils_js_1=require("../utils/process-utils.js"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),file_util_js_1=require("../utils/file-util.js");class CompileNode extends ohos_hap_task_js_1.OhosHapTask{constructor(e,t,s){var o;super(e,{...s,name:`${CompileNode.getCompileNodeTaskName(t,s.name)}`}),this._log=ohos_logger_js_1.OhosLogger.getLogger(CompileNode.name),this.commonOption={path:path_1.default.dirname(process.execPath),watchMode:"false"},this._webpackPath="./node_modules/webpack/bin/webpack.js";const i=e.getTargetData().getTargetName();this.codeType=t,this.codeModel=this.moduleModel.getSourceSetByTargetName(i).getCodeMap().get(this.codeType),this.isArkModule=this.service.isArkModule(),this.sourcePath=null===(o=this.codeModel)||void 0===o?void 0:o.getSrcPath(),this.aceSuperVisualPath=path_1.default.resolve(this.moduleModel.getSourceRootByTargetName(i),"supervisual"),this.aceModuleJsonPath=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),common_const_js_1.CommonConst.MODULE_JSON),this.resourceTable=path_1.default.resolve(this.pathInfo.getIntermediatesRes(),build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),this.resProfileDir=this.pathInfo.getIntermediatesResProfilePath(),this.aceBuildJsonDir=this.pathInfo.getIntermediatesLoaderPath(),this.aceModuleBuild=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),this.codeType),this.loaderWorkDir=this.codeType===code_type_enum_js_1.CodeType.ETS?this.sdkInfo.getEtsLoader():this.sdkInfo.getJsLoader(),this.webpackConfig=this.codeType===code_type_enum_js_1.CodeType.ETS?common_const_js_1.CommonConst.ETS_WEBPACK_FILE:common_const_js_1.CommonConst.ACE_RICH_WEBPACK_FILE;const r=this.moduleModel.getSourceRootByTargetName(common_const_js_1.DefaultTargetConst.DEFAULT_TARGET);this.mainCodePath=path_1.default.resolve(r,this.codeType.toString().toLowerCase())}static getCompileNodeTaskName(e,t){return e===code_type_enum_js_1.CodeType.ETS?`${t}ArkTS`:`${t}${e.toUpperCase()}`}initTaskDepends(){this.module.registryDependsOnTask(this,new generate_loader_json_js_1.GenerateLoaderJson(this.targetService),new compile_resource_js_1.CompileResource(this.targetService))}declareInputs(){const e=new Map,t=project_file_reader_js_1.ProjectFileReader.getJson5Obj(this.moduleModel.getPackageJsonPath());if(void 0!==t.dependencies)for(const[s,o]of Object.entries(t.dependencies))e.set(s,`${s}: ${o}`);return e.set("debuggable",inject_util_js_1.InjectUtil.isDebug()).set("isArk",this.isArkModule)}declareOutputFiles(){return(new file_set_js_1.FileSet).addEntry(this.aceModuleBuild,{isDirectory:!0})}declareInputFiles(){const e=(new file_set_js_1.FileSet).addEntry(this.aceBuildJsonDir,{isDirectory:!0}).addEntry(this.aceModuleJsonPath).addEntry(this.resourceTable).addEntry(this.resProfileDir,{isDirectory:!0}).addEntries(this.getAllExistDependentMainPath()).addEntries(this.getAllExistHarSrcPath(),{isDirectory:!0});return this.aceSuperVisualPath&&fse.existsSync(this.aceSuperVisualPath)&&e.addEntry(this.aceSuperVisualPath,{isDirectory:!0}),this.sourcePath&&fse.existsSync(this.sourcePath)&&e.addEntry(this.sourcePath,{isDirectory:!0}),e}getAllExistHarSrcPath(){return this.service.getDependencyRootPaths().map((e=>path_1.default.resolve(e,"src","main",this.codeType))).filter((e=>fse.existsSync(e)))}getAllExistDependentMainPath(){return this.service.getDependencyMainPaths().filter((e=>fse.existsSync(e)))}doTaskAction(){this.validateModuleJson(),this.doRealLoaderCompile(this.generateLoaderEnv(),(e=>{this.moveReleaseMap(e)}),[this.targetData],[0,1])}taskShouldDo(){return void 0!==this.sourcePath}moveReleaseMap(e,t=this.codeType){const s=path_1.default.resolve(this.pathInfo.getInterMediatesLoaderOutPath(),t,build_directory_const_js_1.BuildArtifactConst.RELEASE_MAP);if(!fse.existsSync(s))return;const o=path_1.default.resolve(this.getTaskTempDir(e),t,build_directory_const_js_1.BuildArtifactConst.RELEASE_MAP);fse.existsSync(o)&&fse.removeSync(o),fse.moveSync(s,o),this._log.debug(`move ${s} to ${o}`)}doRealLoaderCompile(e,t,s,o){var i;e.runtimeOS=null!==(i=this.targetData.getTargetOpt().runtimeOS)&&void 0!==i?i:"OpenHarmony",e.sdkInfo=`${this.sdkInfo.isOhos}:${this.sdkInfo.getSdkVersion()}:${this.sdkInfo.getToolchainsComponentVersion()}:${this.sdkInfo.getReleaseType()}`,fse.ensureDirSync(e.cachePath),fse.ensureDirSync(e.aceModuleBuild);const r=new node_command_builder_js_1.NodeCommandBuilder(!0).addWebpackPath(this._webpackPath).addWebpackConfig(this.webpackConfig).addBuildMode(inject_util_js_1.InjectUtil.isDebug());this.isArkModule&&r.addCompilerType("ark"),this._log._printDebugCommand("NodeEnv",e),this._log._printDebugCommand(`${this.codeType.toUpperCase()}-loader`,r.build());const a=this.getInputData(e,r.build());new process_utils_js_1.ProcessUtils(a.moduleName,a.taskName).submitSyncExecutionWithoutReturn(this.getWorkerPool(),a,t,s,o)}beforeTask(){file_util_js_1.FileUtil.recursiveRmdirSync(this.aceModuleBuild)}getInputData(e,t){const s={cwd:this.loaderWorkDir,env:e};return{moduleName:this.moduleName,taskName:this.name,commandLine:t,commandOptions:s}}generateLoaderEnv(){return{...this.commonOption,appResource:this.resourceTable,aceModuleBuild:this.aceModuleBuild,aceModuleRoot:this.sourcePath,cachePath:this.getTaskTempDir(this.targetData),aceProfilePath:this.resProfileDir,aceModuleJsonPath:this.aceModuleJsonPath,aceSuperVisualPath:this.aceSuperVisualPath,aceBuildJson:path_1.default.resolve(this.aceBuildJsonDir,build_directory_const_js_1.BuildArtifactConst.LOADER_JSON)}}validateModuleJson(){this.validateModulePage(),this.validateModuleSrcEntrance()}validateModulePage(){const e=project_file_reader_js_1.ProjectFileReader.getJson5Obj(this.aceModuleJsonPath).module.pages,t=`${e.replace(/\$profile:/,"")}.json`,s=path_1.default.resolve(this.resProfileDir,t);fse.existsSync(s)||this._log._buildError(`Module page '${e}' not found.`)._solution(`Make sure /resources/base/profile/${t}.json exists.`)._printErrorAndExit()}validateModuleSrcEntrance(){const e=project_file_reader_js_1.ProjectFileReader.getJson5Obj(this.aceModuleJsonPath).module.srcEntrance;if(void 0===e)return;const t=this.moduleModel.getSourceSetByTargetName(this.targetData.getTargetName()),s=path_1.default.isAbsolute(e)?e:path_1.default.resolve(t.getSourceSetRoot(),e);if(!fse.existsSync(s)){const s=t;this._log._buildError(`Module-srcEntance '${e}' not found.`)._solution(`Make sure ${e} exists.`)._file(s.getModuleTargetRes().getJsonPath())._printErrorAndExit()}}getTaskTempDir(e){const t=path_1.default.resolve(super.getTaskTempDir(e),`${this.moduleModel.getCompileMode()}`);return fse.existsSync(t)||fse.mkdirsSync(t),t}}exports.CompileNode=CompileNode;