"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.MakePackInfo=void 0;const ohos_logger_js_1=require("../utils/log/ohos-logger.js"),task_names_js_1=require("./common/task-names.js"),merge_profile_js_1=require("./merge-profile.js");var Task=task_names_js_1.TaskNames.Task;const abstract_make_pack_info_js_1=require("./abstract-make-pack-info.js"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js");class MakePackInfo extends abstract_make_pack_info_js_1.AbstractMakePackInfo{constructor(e){super(e,Task.MAKE_PACK_INFO),this.log=ohos_logger_js_1.OhosLogger.getLogger(MakePackInfo.name)}declareInputs(){return super.declareInputs().set("releaseType",this.sdkInfo.getReleaseType())}declareInputFiles(){const e=this.projectModel.getAppRes().getJsonPath(),t=this.targetService.getTargetData().getModuleSourceSetModel().getModuleTargetRes().getJsonPath();return(new file_set_js_1.FileSet).addEntry(e).addEntry(t)}initTaskDepends(){this.module.registryDependsOnTask(this,new merge_profile_js_1.MergeProfile(this.targetService))}doTaskAction(){const e=this.projectModel.getAppRes().getAppResOpt(),t=this.targetData.getProduct().bundleName,s={code:e.app.versionCode,name:e.app.versionName,minCompatibleVersionCode:e.app.minCompatibleVersionCode},o={bundleName:null!=t?t:e.app.bundleName,version:s};this.doMakePackInfo(this.log,o)}processExtensionAbilities(e,t,s){if(void 0===e)return;const o=[];for(const a of e){const e={name:a.name,forms:this.processForms(MakePackInfo.processMetaData(a.metadata,t,s))};o.push(e)}return o}static processMetaData(e,t,s){if(void 0===e)return;const o=[];for(const a of e){const e=MakePackInfo.processResourcePath(a.resource);if(a.name&&a.name.indexOf("form")>=0&&void 0!==e){const a=t.getFormJsonObjByTargetName(s,e).forms;for(let e=0;e<a.length;e++)o.push(a[e])}}return o}static processResourcePath(e){if(!e)return;const t=e.split(":");return 2!==t.length||"$"!==t[0].charAt(0)||t[0].length<2?void 0:`base/${t[0].substring(1)}/${t[1]}.json`}getModuleObj(e,t,s,o){const a=t.getJsonObjByTargetName(o),r={moduleType:a.module.type,installationFree:a.module.installationFree,deliveryWithInstall:a.module.deliveryWithInstall,moduleName:a.module.name},i={compatible:this.service.getProjectModel().getCompatibleApiVersion(),releaseType:this.sdkInfo.getReleaseType(),target:this.service.getProjectModel().getCompileApiVersion()};return{mainAbility:a.module.mainElement,deviceType:e,abilities:this.processAbilities(a.module.abilities),extensionAbilities:this.processExtensionAbilities(a.module.extensionAbilities,t,o),distro:r,apiVersion:i}}getPackageObj(e,t,s){return{deviceType:e.getTargetDeviceType(),moduleType:t.module.type,deliveryWithInstall:t.module.deliveryWithInstall,name:s}}}exports.MakePackInfo=MakePackInfo;