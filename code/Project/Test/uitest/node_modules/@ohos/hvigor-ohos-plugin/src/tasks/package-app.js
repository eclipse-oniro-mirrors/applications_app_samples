"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.PackageApp=void 0;const path_1=__importDefault(require("path")),packing_tool_options_js_1=require("../builder/inner-java-command-builder/packing-tool-options.js"),file_util_js_1=require("../utils/file-util.js"),process_utils_js_1=require("../utils/process-utils.js"),task_names_js_1=require("./common/task-names.js"),fs_extra_1=__importDefault(require("fs-extra")),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),generate_pack_res_js_1=require("./generate-pack-res.js"),base_pack_app_task_js_1=require("./base/base-pack-app-task.js");var Task=task_names_js_1.TaskNames.Task;class PackageApp extends base_pack_app_task_js_1.BasePackAppTask{constructor(e,t){super(e,t,Task.PACKAGE_APP),this.allDestDir=[],this.allSrcHapPath=[],this.allDestHapPath=[];const a=this.service.getPathInfo();this.outPath=path_1.default.resolve(a.getProjectOutputPath(),this.service.getAppOutputFileName()),this.service.getProductDataMap().forEach((e=>{for(const t of e){const e=t.getPathInfo().getModuleBuildOutputPath(),a=t.getModuleTargetOutputFileName("",!1),s=path_1.default.resolve(e,a),i=path_1.default.resolve(e,"app");this.allDestDir.push(i);const r=t.getRelatedEntryModules();if(r.length)for(const a of r){const s=t.getModuleTargetOutputFileName(a,!1),r=path_1.default.resolve(e,s),l=path_1.default.resolve(i,s.replace("-unsigned",""));this.allSrcHapPath.push(r),this.allDestHapPath.push(l)}else{const e=path_1.default.resolve(i,a.replace("-unsigned",""));this.allSrcHapPath.push(s),this.allDestHapPath.push(e)}}}))}declareExecutionCommand(){return`${this.getPackAppCommand().toString()}`}declareInputs(){return(new Map).set("allDestDir",this.allDestDir)}declareInputFiles(){const e=(new file_set_js_1.FileSet).addEntries([this.packInfoPath,...this.allSrcHapPath],{isDirectory:!1});return this.needPackRes&&e.addEntry(this.packResPath,{isDirectory:!0}),e}declareOutputFiles(){return super.declareOutputFiles().addEntries([this.outPath,...this.allDestHapPath],{isDirectory:!1})}initTaskDepends(){this.project.registryDependsOnTask(this,new generate_pack_res_js_1.GeneratePackRes(this.project,this.service))}doTaskAction(){this.getUnpackedHaps();const e=this.getPackAppCommand();this._log._printDebugCommand("PackageApp",e),(new process_utils_js_1.ProcessUtils).executeSync(e)}getPackAppCommand(){const e=new packing_tool_options_js_1.PackingToolOptions;return e.addCalledJarFile(this.packageTool),this.needPackRes&&fs_extra_1.default.existsSync(this.packResPath)&&e.addPackResPath(this.packResPath),e.addMode("app").addPackInfoPath(this.packInfoPath).addHapPath(this.allDestHapPath.join(",")).force(!0).addOutPath(this.outPath),e.build()}getUnpackedHaps(){for(const e of this.allDestDir)file_util_js_1.FileUtil.checkDirWithoutDelete(e);for(let e=0;e<this.allSrcHapPath.length;e++)PackageApp.writeFile(this.allDestHapPath[e],this.allSrcHapPath[e])}static writeFile(e,t){file_util_js_1.FileUtil.checkFile(e),fs_extra_1.default.writeFileSync(e,fs_extra_1.default.readFileSync(t))}}exports.PackageApp=PackageApp;