"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(e,t,s,i){void 0===i&&(i=s);var r=Object.getOwnPropertyDescriptor(t,s);r&&!("get"in r?!t.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return t[s]}}),Object.defineProperty(e,i,r)}:function(e,t,s,i){void 0===i&&(i=s),e[i]=t[s]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(e,t){Object.defineProperty(e,"default",{enumerable:!0,value:t})}:function(e,t){e.default=t}),__importStar=this&&this.__importStar||function(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var s in e)"default"!==s&&Object.prototype.hasOwnProperty.call(e,s)&&__createBinding(t,e,s);return __setModuleDefault(t,e),t},__importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.AbstractPackageHar=void 0;const ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),system_util_js_1=require("../../utils/system-util.js"),path_1=__importDefault(require("path")),fs=__importStar(require("fs-extra")),process_utils_js_1=require("../../utils/process-utils.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),npm_command_builder_js_1=require("../../builder/npm-command-builder.js"),log_combine_type_js_1=require("../../utils/log/log-combine-type.js"),file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js"),json5_reader_js_1=require("@ohos/hvigor-base/src/util/json5-reader.js"),har_extend_info_js_1=require("../har/har-extend-info.js"),ohos_har_task_js_1=require("../task/ohos-har-task.js"),_log=ohos_logger_js_1.OhosLogger.getLogger("PackageHar"),isFileSpec=(0,system_util_js_1.isWindows)()?/^(?:[.]|~[/]|[/\\]|[a-zA-Z]:)/:/^(?:[.]|~[/]|[/]|[a-zA-Z]:)/,hasSlashes=(0,system_util_js_1.isWindows)()?/\\|[/]/:/[/]/,isFileName=/[.](?:tgz|tar.gz|tar)$/i;class AbstractPackageHar extends ohos_har_task_js_1.OhosHarTask{constructor(e,t){super(e,t),this.allInvalidPrefix=[],this._moduleDir=this.moduleModel.getProjectDir(),this._harExtendInfo=new har_extend_info_js_1.HarExtendInfo(this.moduleModel),this.taskTmpDir=this.getTaskTempDir(this.targetData,void 0,!1),this.outputDir=this.pathInfo.getModuleBuildOutputPath(),this.resourceDir=this.pathInfo.getIntermediatesRes(),this.processedLibs=this.pathInfo.getIntermediatesProcessLibs(),this.resourceTablePath=path_1.default.resolve(this.resourceDir,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT),this.harProfile=this.pathInfo.getIntermediatesMergeProfileDir(),this.harModuleJson=path_1.default.resolve(this.taskTmpDir,"src","main",common_const_js_1.CommonConst.MODULE_JSON5),this.cmakeListDir=this._harExtendInfo.getCmakeListPath(),this.cppTypes=path_1.default.resolve(this._moduleDir,"src","main","cpp","types"),this.hasNativeOption=this._harExtendInfo.hasConfiguredNativeOption(),this.needCppTypes=fs.pathExistsSync(this.cppTypes),this.npmPath=path_1.default.dirname(process.execPath),this.npmCommand=new npm_command_builder_js_1.NpmCommandBuilder(this.npmPath).addAllParams(["pack"]),this.initModuleToplevelPathFilter()}declareExecutionCommand(){return`${this.npmCommand.toString()}`}declareExecutionEnv(){return(new Map).set("cwd",this.taskTmpDir)}declareInputs(){const e=(new Map).set("hasNativeOption",this.hasNativeOption).set("needCppTypes",this.needCppTypes).set("harModuleJson",this.harModuleJson);return this.hasNativeOption&&e.set("cmakeListDir",this.cmakeListDir),this.hasNativeOption&&this.needCppTypes&&e.set("cppTypes",this.cppTypes),e}declareInputFiles(){const e=this.allInvalidPrefix.join("|").replace(/\\/g,"\\\\"),t=RegExp(`^(?!${e}).*`),s=(new file_set_js_1.FileSet).addEntry(this.harProfile,{isDirectory:!0}).addEntry(this._moduleDir,{isDirectory:!0,test:t});return fs.pathExistsSync(this.processedLibs)&&s.addEntry(this.processedLibs,{isDirectory:!0}),fs.pathExistsSync(this.resourceTablePath)&&s.addEntry(this.resourceTablePath,{isDirectory:!1}),s}declareOutputFiles(){return(new file_set_js_1.FileSet).addEntries([this.taskTmpDir,this.outputDir],{isDirectory:!0})}initModuleToplevelPathFilter(){const e=[build_directory_const_js_1.BuildDirConst.LIBS,build_directory_const_js_1.BuildDirConst.BUILD_ROOT,common_const_js_1.CommonNodeConst.NODE_MODULES,".cxx",".previewer",".hvigor",".gitignore"];e.includes(this.pathInfo.getBuildRoot())||e.push(this.pathInfo.getBuildRoot()),e.forEach((e=>{this.allInvalidPrefix.push(path_1.default.resolve(this._moduleDir,e))}))}doTaskAction(){this.preCheckBeforePack(),this.copyCommonSourceFileToTempDir(),this.copyModuleSourceFileToTempDir(),this.copyBuildIntermediatesOutToTempDir(),this.executeNpmPack()}copyCommonSourceFileToTempDir(){this.hasNativeOption&&this.needCppTypes&&fs.copySync(this.cppTypes,path_1.default.resolve(this.taskTmpDir,"src","main","cpp","types"))}copyModuleSourceFileToTempDir(){fs.readdirSync(this._moduleDir).forEach((e=>{const t=path_1.default.resolve(this._moduleDir,e);this.allInvalidPrefix.includes(t)||fs.copySync(t,path_1.default.resolve(this.taskTmpDir,e),{filter:e=>!(this.hasNativeOption&&e===this.cmakeListDir)})})),fs.pathExistsSync(this.harModuleJson)&&fs.removeSync(this.harModuleJson),this.hasNativeOption&&this.needCppTypes&&fs.copySync(this.cppTypes,path_1.default.resolve(this.taskTmpDir,"src","main","cpp","types"))}preCheckBeforePack(){const e=this.moduleModel.getPackageJsonPath();checkHasLocalFileDependency(e)&&_log._buildError("Local dependencies are not supported during HAR build.")._detail("Check the package.json file of the current library module and delete the local dependencies.")._file(e)._printErrorAndExit(),fs.emptyDirSync(this.outputDir),fs.emptyDirSync(this.taskTmpDir)}copyBuildIntermediatesOutToTempDir(){fs.pathExistsSync(this.processedLibs)&&fs.copySync(this.processedLibs,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildDirConst.LIBS)),fs.pathExistsSync(this.resourceTablePath)&&fs.copySync(this.resourceTablePath,path_1.default.resolve(this.taskTmpDir,build_directory_const_js_1.BuildArtifactConst.RESOURCE_TABLE_TXT)),fs.copySync(this.harProfile,path_1.default.resolve(this.taskTmpDir,"src","main"))}executeNpmPack(){const e={moduleName:this.moduleName,taskName:this.name,commandLine:this.npmCommand,commandOptions:{cwd:this.taskTmpDir}},t=e=>{fs.copySync(this.taskTmpDir,this.outputDir,{filter:t=>!fs.lstatSync(t).isDirectory()&&t.endsWith(e)||t===this.taskTmpDir})};if(!new process_utils_js_1.ProcessUtils(this.moduleName,this.name).submitSyncExecutionWithReturn(this.getWorkerPool(),"packageHar",e,t)){t(new process_utils_js_1.ProcessUtils(this.moduleName,this.name).executeSync(e.commandLine,e.commandOptions,log_combine_type_js_1.LogCombineType.DEBUG).stdout.toString())}}}function checkHasLocalFileDependency(e){const t=json5_reader_js_1.Json5Reader.getJson5Obj(e);return void 0!==t.dependencies&&Object.values(t.dependencies).some((e=>isLocalDependency(e)))}function isLocalDependency(e){return!!e&&(isFileSpec.test(e)||/^file:/i.test(e)||hasSlashes.test(e)||isFileName.test(e))}exports.AbstractPackageHar=AbstractPackageHar;