"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.LoopPriorityDispatcher=void 0;const log_js_1=require("../log-collection/log.js"),tcb_store_js_1=require("../store/tcb-store.js"),cpu_js_1=require("../../../util/cpu.js"),constant_js_1=require("../constant/constant.js");class LoopPriorityDispatcher{constructor(){this.failedAttempts=0}dispatch(t,e,o,s){if(e.empty())return!1;if(cpu_js_1.cpuUsage>=constant_js_1.PoolConstant.CPU_LIMIT&&this.failedAttempts<constant_js_1.PoolConstant.MAX_FAIL_ATTEMPTS)return this.failedAttempts++,setTimeout((()=>{this.dispatch(t,e,o,s)}),constant_js_1.PoolConstant.FAIL_DISPATCH_INTERVAL),!1;this.failedAttempts=0;const r=e,i=e=>{if(o.isBusyWorker(e)||!o.isIdleWorker(e)&&!o.createWorker(e))return!1;const s=r.getFirstWaitingWork(e);return!!s&&(o.doWork(s,tcb_store_js_1.TcbStore.getTCB(s.getId()).getCallback(),tcb_store_js_1.TcbStore.getTCB(s.getId()).getCallbackInput(),e)?(tcb_store_js_1.TcbStore.getTCB(s.getId()).isWarmUp()||t.addLog((0,log_js_1.generateScheduleLog)(`${Date.now()}`,s.getId(),e)),!0):(r.pushWork(s,e),!1))};if(void 0!==s)return i(s);for(let t=0;t<o.getMaxPoolNum();t++)if(i(t))return!0;return!1}}exports.LoopPriorityDispatcher=LoopPriorityDispatcher;