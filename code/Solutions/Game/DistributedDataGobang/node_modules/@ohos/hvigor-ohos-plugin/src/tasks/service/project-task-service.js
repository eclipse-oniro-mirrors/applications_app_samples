"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProjectTaskService=void 0;const sdkmanager_common_1=require("@ohos/sdkmanager-common"),path_1=__importDefault(require("path")),util_1=__importDefault(require("util")),find_target_product_js_1=require("../../common/find-target-product.js"),project_path_info_iml_js_1=require("../../common/iml/project-path-info-iml.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),common_const_js_1=require("../../const/common-const.js"),runtime_type_enum_js_1=require("../../enum/runtime-type-enum.js"),default_plugin_id_js_1=require("../../plugin/common/default-plugin-id.js"),project_extra_info_service_js_1=require("../../project/project-extra-info-service.js"),sdk_info_js_1=require("../../sdk/sdk-info.js"),array_util_js_1=require("../../utils/array-util.js"),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),task_service_js_1=require("./task-service.js"),abstract_hap_module_plugin_js_1=require("../../plugin/common/abstract-hap-module-plugin.js"),ohosTestTargetName=common_const_js_1.DefaultTargetConst.OHOS_TEST_TARGET;class ProjectTaskService extends task_service_js_1.TaskService{constructor(e,t,o,r){super(e,t,o,r),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProjectTaskService.name),this.initProductData=()=>{const e=this.hvigorNode;null==e||e.getSubModules().forEach((e=>{var t;const o=e.getName(),r=e.getPluginById(default_plugin_id_js_1.DefaultPluginId.OHOS_HAP_PLUGIN),s=[];if(void 0!==r&&r instanceof abstract_hap_module_plugin_js_1.AbstractHapModulePlugin){const e=null===(t=this._projectModel)||void 0===t?void 0:t.getModuleProfileOpt(o),i=null==e?void 0:e.targets,n=r.getTaskService().getTargetDataSet(),_=new Set;n.forEach((e=>{_.add(e[0].getTargetName());void 0!==(0,array_util_js_1.getElementFromArr)(i,e[0].getTargetName())&&(this.checkIsOhosTestTarget(e[0]),e[1]&&s.push(e[0]))})),this.checkTargetIsUnknown(_,i),0!==s.length&&this._productDataMap.set(o,s)}}))},this._targetProduct=(0,find_target_product_js_1.findTargetProduct)(t),this._moduleDependencyInfo=o;const s=project_extra_info_service_js_1.ProjectExtraInfoService.getProjectRuntimeOS(t)===runtime_type_enum_js_1.RuntimeTypeEnum.OpenHarmony;this._sdkInfo=new sdk_info_js_1.SdkInfo(t.getCompileApiVersion(),[sdkmanager_common_1.ComponentPath.TOOLCHAINS],s),this._pathInfo=new project_path_info_iml_js_1.ProjectPathInfoIml(t,this._targetProduct.name),this._productDataMap=new Map,this.initProductData()}getSdkInfo(){return this._sdkInfo}getProductDataMap(){return this._productDataMap}getPathInfo(){return this._pathInfo}getTargetProduct(){return this._targetProduct}getAppOutputFileName(e=!1){const t=e?"signed":"unsigned";return`${this._projectModel.getName()}-${this._targetProduct.name}-${t}${build_directory_const_js_1.BuildArtifactExtension.DOT_APP}`}checkIsOhosTestTarget(e){if(e.getTargetName()!==ohosTestTargetName)return;const t=`Delete the 'ohosTest' configuration from the 'targets' field in the '${e.getModuleModel().getModule().getName()}' module in the build_profile.json5 file.`;this._log._buildError("The 'ohosTest' target does not need to be packaged into the application. 'ohosTest' target cannot be applied to product")._solution(t)._file(this._projectModel.getProfilePath())._printErrorAndExit()}checkTargetIsUnknown(e,t){var o;if(t)for(const r of t)e.has(r.name)||this._log._buildError(`Unknown target '${r.name}'.`)._solution(`Check the value of name under the targets tag of the module: ${util_1.default.format(r)}.`)._file(path_1.default.resolve(null===(o=this._projectModel)||void 0===o?void 0:o.getProjectDir(),common_const_js_1.CommonConst.PROFILE_JSON5))._printErrorAndExit()}}exports.ProjectTaskService=ProjectTaskService;