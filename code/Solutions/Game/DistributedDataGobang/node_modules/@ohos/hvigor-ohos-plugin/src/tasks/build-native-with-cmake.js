"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.BuildNativeWithCmake=void 0;const lodash_1=require("lodash"),path_1=__importDefault(require("path")),native_command_builder_js_1=require("../builder/native-command-builder.js"),cmake_util_js_1=require("../utils/cmake-util.js"),inject_util_js_1=require("../utils/inject-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),abstract_build_native_js_1=require("./abstract-build-native.js"),task_names_js_1=require("./common/task-names.js"),legacy_pre_build_js_1=require("./legacy-tasks/legacy-pre-build.js"),pre_build_js_1=require("./pre-build.js"),file_util_js_1=require("../utils/file-util.js");var Task=task_names_js_1.TaskNames.Task;class BuildNativeWithCmake extends abstract_build_native_js_1.AbstractBuildNative{constructor(e){super(e,Task.BUILD_NATIVE_WITH_CMAKE),this._log=ohos_logger_js_1.OhosLogger.getLogger(BuildNativeWithCmake.name),this.isNativeChanged=!0,this._moduleDir=this.moduleModel.getProjectDir()}initTaskDepends(){this.isFaMode?this.module.registryDependsOnTask(this,new legacy_pre_build_js_1.LegacyPreBuild(this.targetService)):this.module.registryDependsOnTask(this,new pre_build_js_1.PreBuild(this.targetService))}taskShouldDo(){return cmake_util_js_1.CmakeUtil.nativeTaskCondition(this.moduleModel,this.targetData,this._nativeOption)}doTaskAction(){file_util_js_1.FileUtil.checkDirWithoutDelete(this.pathInfo.getModuleBuildPath()),file_util_js_1.FileUtil.checkDirWithoutDelete(this.pathInfo.getCppOutputDir()),this.isNativeChanged=cmake_util_js_1.CmakeUtil.checkNativeCache(this.moduleModel,this.sdkInfo.getCmakeTool());cmake_util_js_1.CmakeUtil.checkAbiFilters(this._nativeOption.abiFilters,!this.targetData.isHarmonyOS(),this.sdkInfo.getNdkVersion()).forEach((e=>{const t=this.buildCommand(e);this.executeCommand(t,lodash_1.noop,[],[0,1])}))}buildCommand(e){var t,i,a,s,l;const o=new native_command_builder_js_1.NativeCommandBuilder(this.sdkInfo.getCmakeTool()),d=path_1.default.resolve(this.pathInfo.getIntermediatesCppOutPut(),e),_=path_1.default.resolve(this.pathInfo.getNinjaWorkDir(),e);cmake_util_js_1.CmakeUtil.mkCodeModelRequest(_),this.isNativeChanged&&cmake_util_js_1.CmakeUtil.cleanCache(_);const r=inject_util_js_1.InjectUtil.isDebug()?"Debug":"Release";o.addCmakeList(cmake_util_js_1.CmakeUtil.getCmakeListDir(this._moduleDir,null===(t=this._nativeOption)||void 0===t?void 0:t.path)).addTempFilePath(_).addOhosArch(e).addOutputDir(d).addBuildType(r).addNativeSdk(this.sdkInfo.getSdkNativeDir()).addSystemName("OHOS").addOhosArchAbi(e).exportCompileCommands("ON").addToolChain(this.sdkInfo.getNativeToolchain()).addGenerator("Ninja").addMakeProgramPath(this.sdkInfo.getNativeNinjaTool()).muteUnusedCliWarn();const u=null===(i=this._nativeOption)||void 0===i?void 0:i.cFlags,n=null===(a=this._nativeOption)||void 0===a?void 0:a.cppFlags;u&&""!==u.trim()&&o.addCFlags(u),n&&""!==n.trim()&&o.addCxxFlags(n);let h=o.build();const m=(null===(s=this._nativeOption)||void 0===s?void 0:s.arguments)?null===(l=this._nativeOption)||void 0===l?void 0:l.arguments:"";return h=cmake_util_js_1.CmakeUtil.mergeCommandLine(h,m),this._log._printDebugCommand("Cmake",h),h}}exports.BuildNativeWithCmake=BuildNativeWithCmake;