"use strict";var __createBinding=this&&this.__createBinding||(Object.create?function(t,e,i,s){void 0===s&&(s=i);var r=Object.getOwnPropertyDescriptor(e,i);r&&!("get"in r?!e.__esModule:r.writable||r.configurable)||(r={enumerable:!0,get:function(){return e[i]}}),Object.defineProperty(t,s,r)}:function(t,e,i,s){void 0===s&&(s=i),t[s]=e[i]}),__setModuleDefault=this&&this.__setModuleDefault||(Object.create?function(t,e){Object.defineProperty(t,"default",{enumerable:!0,value:e})}:function(t,e){t.default=e}),__importStar=this&&this.__importStar||function(t){if(t&&t.__esModule)return t;var e={};if(null!=t)for(var i in t)"default"!==i&&Object.prototype.hasOwnProperty.call(t,i)&&__createBinding(e,t,i);return __setModuleDefault(e,t),e},__importDefault=this&&this.__importDefault||function(t){return t&&t.__esModule?t:{default:t}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ProcessLibs=void 0;const fs=__importStar(require("fs-extra")),glob_1=require("glob"),minimatch=__importStar(require("minimatch")),os_1=__importDefault(require("os")),path_1=__importDefault(require("path")),build_directory_const_js_1=require("../const/build-directory-const.js"),cmake_util_js_1=require("../utils/cmake-util.js"),file_util_js_1=require("../utils/file-util.js"),ohos_logger_js_1=require("../utils/log/ohos-logger.js"),build_native_with_ninja_js_1=require("./build-native-with-ninja.js"),task_names_js_1=require("./common/task-names.js"),ohos_hap_task_js_1=require("./task/ohos-hap-task.js");var Task=task_names_js_1.TaskNames.Task;const file_set_js_1=require("@ohos/hvigor-base/src/internal/snapshot/util/file-set.js");class ProcessLibs extends ohos_hap_task_js_1.OhosHapTask{constructor(t){var e,i,s,r;super(t,Task.PROCESS_LIB),this._log=ohos_logger_js_1.OhosLogger.getLogger(ProcessLibs.name);const o=t.getTargetData().getPathInfo();this._moduleDir=this.moduleModel.getProjectDir(),this.hapLocalLibs=path_1.default.resolve(this._moduleDir,build_directory_const_js_1.BuildDirConst.LIBS),this.allHarLibs=this.getAllHarLibs(),this.libsOutputDir=o.getIntermediatesProcessLibs(),this.localOutput=o.getIntermediatesCppOutPut(),this._nativeOption=null===(e=this.moduleModel.getProfileOpt().buildOption)||void 0===e?void 0:e.externalNativeOptions,this.filterRule=void 0===(null===(s=null===(i=this.targetData.getTargetOpt().config)||void 0===i?void 0:i.buildOption)||void 0===s?void 0:s.napiLibFilterOption)?null===(r=this.moduleModel.getProfileOpt().buildOption)||void 0===r?void 0:r.napiLibFilterOption:this.targetData.getTargetOpt().config.buildOption.napiLibFilterOption}declareInputs(){const t=super.declareInputs();if(void 0!==this.filterRule&&Object.entries(this.filterRule).forEach((([e,i])=>{void 0!==i&&t.set(e,i)})),cmake_util_js_1.CmakeUtil.nativeTaskCondition(this.moduleModel,this.targetData,this._nativeOption)){const e=file_util_js_1.FileUtil.hashEntry(this.localOutput);t.set("LOCAL_OUTPUT",e)}return t}declareInputFiles(){const t=new file_set_js_1.FileSet;return fs.existsSync(this.hapLocalLibs)&&t.addEntry(this.hapLocalLibs,{isDirectory:!0}),this.allHarLibs.forEach((e=>{fs.existsSync(e)&&t.addEntry(e,{isDirectory:!0})})),t}declareOutputFiles(){return(new file_set_js_1.FileSet).addEntry(this.libsOutputDir,{isDirectory:!0})}initTaskDepends(){this.module.registryDependsOnTask(this,new build_native_with_ninja_js_1.BuildNativeWithNinja(this.targetService))}initHarModuleDepends(){this.service.getModuleDependencyNames().forEach((t=>{this.dependsOn(`default@${Task.PROCESS_LIB.name}`,t)}))}doTaskAction(){const t=this.pathInfo,{excludes:e,pickFirsts:i,pickLasts:s,enableOverride:r}={excludes:[],pickFirsts:[],pickLasts:[],enableOverride:!1,...this.filterRule},o=path_1.default.resolve(t.getIntermediatesCppOutPut()),a=[...this.allHarLibs.reverse(),o,this.hapLocalLibs];this._log.debug(`Libs: ${a.join(os_1.default.EOL)}`),fs.emptyDirSync(this.libsOutputDir);const l=new Map;a.forEach((t=>{const o=glob_1.glob.sync("**/*.so",{cwd:t});this._log.debug(`Collect files: ${o}`),o.forEach((o=>{if(e.some((t=>minimatch.default(o,t))))return;if(s.some((t=>minimatch.default(o,t)))&&l.has(o))return;if(i.some((t=>minimatch.default(o,t)))||r)return void l.set(o,path_1.default.resolve(t,o));if(!l.has(o))return void l.set(o,path_1.default.resolve(t,o));const a=l.get(o);"string"==typeof a?l.set(o,[a,path_1.default.resolve(t,o)]):null==a||a.push(path_1.default.resolve(t,o))}))}));let n=!1;const u=[];for(const t of l.keys()){const e=l.get(t),i=path_1.default.basename(t);Array.isArray(e)&&e.length>1&&"libc++.so"!==i&&"libc++_shared.so"!==i&&(n=!0,u.push(`${e.length} file found in 'lib/${t}'. This may cause unexpected errors at runtime.`),e.forEach((t=>{u.push(`- ${t}`)})))}n&&this._log._buildError(u.join(`${os_1.default.EOL}\t `))._solution(`Rename the native compilation products of the module, or configure napiLibFilterOption in ${this.moduleModel.getProfilePath()}.`)._printErrorAndExit(this.moduleName),[...l.entries()].forEach((t=>{const[e,i]=t;"string"==typeof i?fs.copySync(i,path_1.default.resolve(this.libsOutputDir,e)):fs.copySync(i.pop(),path_1.default.resolve(this.libsOutputDir,e))})),this._log.debug(fs.readdirSync(this.libsOutputDir))}getAllHarLibs(){const t=this.service.getDependencyRootPaths(),e=this.service.getModuleDependencyPaths();return this.moduleModel.isHarModule()?[]:t.map((t=>e.includes(t)?path_1.default.resolve(t,this.pathInfo.getBuildRoot(),this.targetData.getProduct().name,build_directory_const_js_1.BuildDirConst.INTERMEDIATES,build_directory_const_js_1.BuildDirConst.LIBS,"default"):path_1.default.resolve(t,build_directory_const_js_1.BuildDirConst.LIBS)))}}exports.ProcessLibs=ProcessLibs;