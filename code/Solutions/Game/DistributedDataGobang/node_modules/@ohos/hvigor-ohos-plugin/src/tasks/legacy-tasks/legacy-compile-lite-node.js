"use strict";var __importDefault=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.LegacyCompileLiteNode=void 0;const code_type_enum_js_1=require("../../enum/code-type-enum.js"),build_directory_const_js_1=require("../../const/build-directory-const.js"),compile_node_js_1=require("../compile-node.js"),path_1=__importDefault(require("path")),ohos_logger_js_1=require("../../utils/log/ohos-logger.js"),hvigor_base_1=require("@ohos/hvigor-base"),legacy_generate_js_manifest_js_1=require("./legacy-generate-js-manifest.js"),common_const_js_1=require("../../const/common-const.js"),node_command_builder_js_1=require("../../builder/node-command-builder.js"),process_utils_js_1=require("../../utils/process-utils.js"),file_util_js_1=require("../../utils/file-util.js"),fs_extra_1=__importDefault(require("fs-extra")),legacy_generate_loader_json_js_1=require("./legacy-generate-loader-json.js"),task_names_js_1=require("../common/task-names.js"),inject_util_js_1=require("../../utils/inject-util.js"),legacy_hook_compile_resource_js_1=require("./hook/legacy-hook-compile-resource.js");class LegacyCompileLiteNode extends compile_node_js_1.CompileNode{constructor(e){super(e,code_type_enum_js_1.CodeType.JS,task_names_js_1.TaskNames.LegacyFATask.COMPILE_LITE_NODE),this.debuggable=hvigor_base_1.hvigor.getExtraConfig().get(common_const_js_1.CommonConst.DEBUGGABLE),this._logger=ohos_logger_js_1.OhosLogger.getLogger(LegacyCompileLiteNode.name)}taskShouldDo(){return this.service.hasLiteDevice()}initTaskDepends(){this.module.registryDependsOnTask(this,new legacy_generate_js_manifest_js_1.LegacyGenerateJsManifest(this.targetService),new legacy_hook_compile_resource_js_1.LegacyHookCompileResource(this.targetService),new legacy_generate_loader_json_js_1.LegacyGenerateLoaderJson(this.targetService))}doTaskAction(){const e=this.service.getModuleModel(),t=e.getSourceSetByTargetName(this.targetName).getCodeMap().get(this.codeType);if(void 0===t)return void this._logger.errorMessageExit("Lite wearable only support JS.");const o=t.getSrcPath(),s=this.pathInfo,i=path_1.default.resolve(s.getIntermediatesLegacyManifestJson()),a=path_1.default.resolve(this.pathInfo.getIntermediatesFaAssetsPath(),code_type_enum_js_1.CodeType.JS),r=e.getLegacyAbilities(this.targetName);file_util_js_1.FileUtil.checkDirWithoutDelete(s.getIntermediatesLiteBinSource()),fs_extra_1.default.copySync(e.getSourceSetByTargetName().getLegacyModuleTargetRes().getResourcePath(),s.getIntermediatesLiteBinSource(),{filter:e=>fs_extra_1.default.statSync(e).isDirectory()||e.toLowerCase().endsWith(".png")||e.toLowerCase().endsWith(".jpg"),recursive:!0});for(let e=0;e<r.length;e++){const t=r[e],_={...this.commonOption,abilityType:t.getType(),aceManifestPath:path_1.default.resolve(i,t.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LEGACY_MANIFEST_JSON),aceModuleRoot:path_1.default.resolve(o,t.getRelateSrcPath()),aceModuleBuild:path_1.default.resolve(a,t.getRelateSrcPath()),hapMode:this.debuggable,img2bin:"true",iconPath:s.getIntermediatesLiteBinSource(),cachePath:this.getTaskTempDir(this.targetData),aceBuildJson:path_1.default.resolve(s.getIntermediatesLoaderPath(),t.getRelateSrcPath(),build_directory_const_js_1.BuildArtifactConst.LOADER_JSON)};this.doRealLoaderCompile(_,((e,t)=>{this.moveReleaseMap(e,t)}),[this.targetData,`js/${t.getRelateSrcPath()}`],[0,1])}}doRealLoaderCompile(e,t,o,s){const i=new node_command_builder_js_1.NodeCommandBuilder(!0).addWebpackPath("./node_modules/webpack/bin/webpack.js").addWebpackConfig(common_const_js_1.CommonConst.ACE_LITE_WEBPACK_FILE).addBuildMode(inject_util_js_1.InjectUtil.isDebug());this._logger._printDebugCommand("NodeEnv",e),this._logger._printDebugCommand("lite-loader",i.build());const a=this.getInputData(e,i.build());new process_utils_js_1.ProcessUtils(a.moduleName,a.taskName).submitSyncExecutionWithoutReturn(this.getWorkerPool(),a,t,o,s)}}exports.LegacyCompileLiteNode=LegacyCompileLiteNode;